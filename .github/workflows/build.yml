name: Build NexusOS Gaming Edition

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            debootstrap live-build cdebootstrap \
            xorriso grub-pc-bin grub-efi-amd64-bin grub-efi-ia32-bin mtools \
            syslinux isolinux graphicsmagick imagemagick feh

      - name: Configure live-build (Debian Bullseye)
        run: |
          sudo lb clean
          sudo lb config \
            --distribution bullseye \
            --architecture amd64 \
            --mirror-bootstrap http://deb.debian.org/debian/ \
            --mirror-chroot http://deb.debian.org/debian/ \
            --mirror-binary http://deb.debian.org/debian/ \
            --mirror-binary-security http://security.debian.org/debian-security \
            --debian-installer live \
            --apt-secure true \
            --bootappend-live "boot=live components quiet splash" \
            --linux-packages "linux-image linux-headers"

          # Fix wrong repos
          sudo sed -i '/ubuntu/d' config/archives/*.list* || true
          sudo sed -i '/restricted/d' config/archives/*.list* || true

          # Add correct Debian security repo
          echo "deb http://security.debian.org/debian-security bullseye-security main contrib non-free" | sudo tee -a config/archives/debian.list.chroot

      - name: Add custom wallpaper and autostart
        run: |
          sudo mkdir -p config/includes.chroot/etc/skel/Pictures
          sudo mkdir -p config/includes.chroot/etc/xdg/autostart

          # Add wallpaper
          if [ -f "wallpaper.jpg" ]; then
            sudo cp wallpaper.jpg config/includes.chroot/etc/skel/Pictures/wallpaper.jpg
          else
            sudo convert -size 1920x1080 xc:black -fill "#00ffcc" -gravity center \
              -pointsize 120 -annotate 0 "NEXUS OS" wallpaper.jpg
            sudo cp wallpaper.jpg config/includes.chroot/etc/skel/Pictures/wallpaper.jpg
          fi

          # Add autostart script
          echo '[Desktop Entry]
          Type=Application
          Name=Set Default Wallpaper
          Exec=sh -c "feh --bg-fill ~/Pictures/wallpaper.jpg || pcmanfm --set-wallpaper ~/Pictures/wallpaper.jpg --wallpaper-mode=fill || true"
          X-GNOME-Autostart-enabled=true' | sudo tee config/includes.chroot/etc/xdg/autostart/set-wallpaper.desktop

      - name: Add NexusOS boot branding
        run: |
          sudo mkdir -p config/bootloaders/isolinux
          sudo mkdir -p config/bootloaders/grub

          # Boot splash images
          sudo convert -size 640x480 xc:black -fill "#00ffcc" -gravity center \
            -pointsize 32 -annotate 0 "Welcome to NexusOS Gaming Edition" config/bootloaders/isolinux/splash.png

          sudo convert -size 800x600 xc:black -fill "#00ffcc" -gravity center \
            -pointsize 42 -annotate 0 "NexusOS Boot Menu" config/bootloaders/grub/splash.png

          # isolinux boot menu
          echo 'UI vesamenu.c32
          PROMPT 0
          TIMEOUT 50
          MENU TITLE NexusOS Boot Menu

          LABEL live
            MENU LABEL ^Start NexusOS (Live)
            KERNEL /live/vmlinuz
            APPEND initrd=/live/initrd.img boot=live quiet splash

          LABEL install
            MENU LABEL ^Install NexusOS
            KERNEL /install/vmlinuz
            APPEND initrd=/install/initrd.gz quiet' | sudo tee config/bootloaders/isolinux/isolinux.cfg

          # GRUB boot menu
          echo 'set default=0
          set timeout=5
          set gfxmode=auto
          insmod gfxterm
          insmod png
          background_image /boot/grub/splash.png
          menuentry "Start NexusOS (Live)" {
              linux /live/vmlinuz boot=live quiet splash
              initrd /live/initrd.img
          }
          menuentry "Install NexusOS" {
              linux /install/vmlinuz quiet
              initrd /install/initrd.gz
          }' | sudo tee config/bootloaders/grub/grub.cfg

      - name: Add Gaming Packages (Steam, Lutris, Wine, Drivers)
        run: |
          sudo mkdir -p config/package-lists
          echo '# Core gaming components
          steam
          lutris
          wine
          winetricks
          gamemode
          mangohud
          vulkan-utils
          mesa-vulkan-drivers
          libvulkan1
          vulkan-tools

          # GPU drivers
          firmware-linux-nonfree
          firmware-amd-graphics
          firmware-misc-nonfree
          xserver-xorg-video-intel
          xserver-xorg-video-amdgpu
          xserver-xorg-video-nouveau
          nvidia-driver
          nvidia-vulkan-icd

          # Desktop and utilities
          xfce4
          xfce4-goodies
          lightdm
          network-manager
          alsa-utils
          pulseaudio
          pavucontrol
          firefox-esr
          curl
          wget
          git
          htop
          neofetch
          gnome-terminal' | sudo tee config/package-lists/gaming.list.chroot

      - name: Build NexusOS ISO
        run: |
          sudo lb build

      - name: Rename and upload ISO
        run: sudo mv live-image-amd64.hybrid.iso NexusOS-Gaming.iso

      - name: Upload ISO as artifact
        uses: actions/upload-artifact@v4
        with:
          name: NexusOS-Gaming-Edition
          path: NexusOS-Gaming.iso
